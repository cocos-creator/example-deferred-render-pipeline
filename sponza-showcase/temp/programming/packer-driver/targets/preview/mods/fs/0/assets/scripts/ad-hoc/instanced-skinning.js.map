{"version":3,"sources":["file:///D:/Deferred_RenderPipeline/sponza-showcase/assets/scripts/ad-hoc/instanced-skinning.ts"],"names":["_decorator","Component","instantiate","Node","Prefab","SkeletalAnimationComponent","Texture2D","director","gfx","UnlitQuadComponent","ccclass","property","InstancedSkinning","start","root","device","hasFeature","Feature","INSTANCED_ARRAYS","_groupCount","Math","min","warningSign","active","_baselineNode","_initGroup","baseline","_updateGroups","baselineVisible","toggleBaselineGroup","e","isChecked","toggleAnimNames","i","_nameLabels","length","setGroups","groupCount","floor","progress","maxGroupCount","_testNodes","push","testgroup","name","prefab","posZ","len","labelImages","group","parent","node","scene","posX","groupPerColumn","inst","setPosition","label","getChildByName","getComponent","texture","animComp","clipName","clips","play","val"],"mappings":"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","sourcesContent":["import { _decorator, Component, instantiate, Node, Prefab, SkeletalAnimationComponent,\r\n    SliderComponent, Texture2D, ToggleComponent, director, gfx } from 'cc';\r\nimport { UnlitQuadComponent } from '../unlit-quad';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('InstancedSkinning')\r\nexport class InstancedSkinning extends Component {\r\n\r\n    @property(Prefab)\r\n    public baseline = null;\r\n\r\n    @property(Prefab)\r\n    public testgroup = null;\r\n\r\n    @property([Texture2D])\r\n    public labelImages: Texture2D[] = [];\r\n\r\n    @property\r\n    public maxGroupCount = 10;\r\n\r\n    @property\r\n    public baselineVisible = true;\r\n\r\n    @property\r\n    private _groupCount = 1;\r\n\r\n    @property\r\n    public groupPerColumn = 100;\r\n\r\n    @property\r\n    set groupCount (val) {\r\n        this._groupCount = val;\r\n        this._updateGroups();\r\n    }\r\n    get groupCount () {\r\n        return this._groupCount;\r\n    }\r\n\r\n    @property(Node)\r\n    warningSign: Node | null = null;\r\n\r\n    private _baselineNode: Node | null = null;\r\n    private _testNodes: Node[] = [];\r\n    private _nameLabels: Node[] = [];\r\n\r\n    public start () {\r\n        // clamp the initial count if instancing is not supported\r\n        if (!director.root!.device.hasFeature(gfx.Feature.INSTANCED_ARRAYS)) {\r\n            this._groupCount = Math.min(this._groupCount, 1);\r\n            if (this.warningSign) { this.warningSign.active = true; }\r\n        }\r\n\r\n        this._baselineNode = this._initGroup('Baseline', this.baseline!, 0);\r\n        this._updateGroups();\r\n        this._baselineNode.active = this.baselineVisible;\r\n    }\r\n\r\n    public toggleBaselineGroup (e: ToggleComponent) {\r\n        this._baselineNode!.active = e.isChecked;\r\n    }\r\n\r\n    public toggleAnimNames (e: ToggleComponent) {\r\n        for (let i = 0; i < this._nameLabels.length; i++) {\r\n            this._nameLabels[i].active = e.isChecked;\r\n        }\r\n    }\r\n\r\n    public setGroups (e: SliderComponent) {\r\n        this.groupCount = Math.floor(e.progress * this.maxGroupCount);\r\n    }\r\n\r\n    private _updateGroups () {\r\n        for (let i = 0; i < this._groupCount; i++) {\r\n            if (this._testNodes[i]) { this._testNodes[i].active = true; }\r\n            else { this._testNodes.push(this._initGroup('TestGroup', this.testgroup!, 5 * (i + 1))); }\r\n        }\r\n        for (let i = this._groupCount; i < this._testNodes.length; i++) {\r\n            this._testNodes[i].active = false;\r\n        }\r\n    }\r\n\r\n    private _initGroup (name: string, prefab: Prefab, posZ: number) {\r\n        const len = this.labelImages.length;\r\n        const group = new Node(name);\r\n        group.parent = this.node.scene as unknown as Node;\r\n        for (let i = 0; i < len; i++) {\r\n            const posX = Math.floor(posZ / this.groupPerColumn) * 30 + i * 3;\r\n            const inst = instantiate(prefab) as Node; inst.setPosition(posX, 0, posZ % this.groupPerColumn); inst.parent = group;\r\n            const label = inst.getChildByName('Label')!.getComponent(UnlitQuadComponent)!;\r\n            label.texture = this.labelImages[i]; this._nameLabels.push(label!.node);\r\n            const animComp = inst.getChildByName('Model')!.getComponent(SkeletalAnimationComponent)!;\r\n            const clipName = inst.name = animComp.clips[i]!.name;\r\n            animComp.play(clipName);\r\n        }\r\n        return group;\r\n    }\r\n}\r\n"]}